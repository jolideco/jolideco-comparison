# Main entrypoint of the workflow. 
# Please follow the best practices: 
# https://snakemake.readthedocs.io/en/stable/snakefiles/best_practices.html,
# in particular regarding the standardized folder structure mentioned there. 

import yaml
from pathlib import Path
from astropy.io import fits

report: "report/workflow.rst"

configfile : "config/config.yaml"

envvars:
    "JOLIDECO_GMM_LIBRARY"

def get_max_values(pattern="*_mod*_*.fits"):
    """Get max values"""
    data_path = Path("data/")
    
    max_values = {}

    for filename in sorted(data_path.glob(pattern)):
        data = fits.getdata(filename)
        key = filename.stem.split("_")[-1]
        max_values[key] = data.max()
    
    return max_values


MAX_VALUES = get_max_values()
MAX_VALUES_NPRED = get_max_values(pattern="*_img*_*.fits")

with Path("config/template.yaml").open("r") as f:
    config_template = yaml.safe_load(f)

config["methods"] = [_["name"] for _ in config_template["runs"]]

include: "rules/init-config.smk"
include: "rules/run-comparison.smk"
include: "rules/plot-results.smk"
include: "rules/plot-datasets.smk"
include: "rules/plot-flux-true.smk"
include: "rules/site-render-summary.smk"
include: "rules/site-render-index.smk"
include: "rules/site-build.smk"

# all rule 
rule all:
    input:
        expand("results/{scenario}/{bkg_level}/{prefix}/{method}/images/flux.png", scenario=config["scenarios"], bkg_level=config["bkg_levels"], prefix=config["prefixes"], method=config["methods"]),
        "site/index.html"
